<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>قبله‌نما با Magnetometer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      text-align: center;
      background: #f5f5f5;
    }
    h1 { margin-top: 20px; font-size: 22px; }
    #status { margin: 10px; font-size: 14px; color: #444; }
    .compass {
      width: 260px; height: 260px;
      margin: 30px auto; position: relative;
      border-radius: 50%; border: 4px solid #333;
      background: radial-gradient(circle, #fff 0%, #ddd 60%, #ccc 100%);
    }
    .kaaba {
      position: absolute; width: 60px; height: 60px;
      top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 3;
    }
    .needle {
      position: absolute; width: 4px; height: 120px;
      background: red; top: 20px; left: 50%;
      transform-origin: 50% 90%; border-radius: 4px;
      z-index: 2;
    }
    .dot {
      position: absolute; width: 16px; height: 16px;
      background: #333; border-radius: 50%;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      border: 2px solid #fff; z-index: 4;
    }
  </style>
</head>
<body>
  <h1>قبله‌نما</h1>
  <div id="status">در حال آماده‌سازی...</div>
  <div class="compass">
    <img src="kaaba.png" class="kaaba" alt="Qibla">
    <div id="needle" class="needle"></div>
    <div class="dot"></div>
  </div>

  <script>
    const QIBLA = 201; // زاویه قبله برای کرمانشاه
    const statusEl = document.getElementById("status");
    const needle = document.getElementById("needle");

    let accel = null;
    let mag = null;

    function startSensors() {
      if ('Accelerometer' in window && 'Magnetometer' in window) {
        accel = new Accelerometer({ frequency: 60 });
        mag = new Magnetometer({ frequency: 60 });

        accel.addEventListener("reading", updateCompass);
        mag.addEventListener("reading", updateCompass);

        accel.start();
        mag.start();

        statusEl.textContent = "در حال دریافت داده...";
      } else {
        statusEl.textContent = "سنسورهای مورد نیاز پشتیبانی نمی‌شوند.";
      }
    }

    function updateCompass() {
      if (!accel || !mag) return;

      // داده‌های شتاب‌سنج
      const ax = accel.x, ay = accel.y, az = accel.z;

      // داده‌های مگنتومتر
      const mx = mag.x, my = mag.y, mz = mag.z;

      // محاسبه heading (زاویه نسبت به شمال مغناطیسی)
      // فرمول ساده‌شده: استفاده از داده‌های ترکیبی
      let heading = Math.atan2(my, mx) * (180 / Math.PI);
      if (heading < 0) heading += 360;

      if (isNaN(heading)) {
        statusEl.textContent = "داده معتبر نیست.";
        return;
      }

      // اختلاف جهت گوشی با قبله
      const relative = QIBLA - heading;

      // چرخش خط قرمز
      needle.style.transform = `translateX(-50%) rotate(${relative}deg)`;

      statusEl.textContent = "گوشی را صاف نگه دارید و بچرخانید.";
    }

    window.onload = startSensors;
  </script>
</body>
</html>
